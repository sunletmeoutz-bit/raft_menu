# -*- coding: utf-8 -*-
# –ú–µ–Ω—é —Å–ø–ª–∞–≤–∞: –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º + –≤—ã–≥—Ä—É–∑–∫–∞ Excel –∏ PDF

import io
import os
import pandas as pd
import streamlit as st

# ==== PDF: –ø—Ä–æ–±—É–µ–º reportlab (—Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π —á–µ—Ä–µ–∑ TTF) ====
REPORTLAB_AVAILABLE = False
try:
    from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph
    from reportlab.lib.pagesizes import A4
    from reportlab.lib import colors
    from reportlab.lib.styles import getSampleStyleSheet
    from reportlab.pdfbase import pdfmetrics
    from reportlab.pdfbase.ttfonts import TTFont
    REPORTLAB_AVAILABLE = True
except Exception:
    pass  # –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ‚Äî –Ω–∏–∂–µ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–æ–æ–±—â–∏–º

# ---------- –î–ê–ù–ù–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ (–≤—Å—ë –Ω–∞ —Ä—É—Å—Å–∫–æ–º) ----------
–ë–õ–Æ–î–ê_–ü–û_–£–ú–û–õ–ß–ê–ù–ò–Æ = [
    # –ë–ª—é–¥–æ, –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç, –ï–¥.–∏–∑–º, –ù–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞
    ("–û–≤—Å—è–Ω–∫–∞ —Å —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç–∞–º–∏","–û–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è","–≥",70),
    ("–û–≤—Å—è–Ω–∫–∞ —Å —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç–∞–º–∏","–°—É—Ö–æ—Ñ—Ä—É–∫—Ç—ã (–º–∏–∫—Å)","–≥",30),
    ("–û–≤—Å—è–Ω–∫–∞ —Å —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç–∞–º–∏","–°–∞—Ö–∞—Ä","–≥",10),
    ("–û–≤—Å—è–Ω–∫–∞ —Å —Å—É—Ö–æ—Ñ—Ä—É–∫—Ç–∞–º–∏","–°–æ–ª—å","–≥",1),

    ("–°—ã—Ä–Ω–∏–∫–∏","–¢–≤–æ—Ä–æ–≥","–≥",180),
    ("–°—ã—Ä–Ω–∏–∫–∏","–Ø–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ","—à—Ç",0.5),
    ("–°—ã—Ä–Ω–∏–∫–∏","–ú—É–∫–∞ –ø—à–µ–Ω–∏—á–Ω–∞—è","–≥",25),
    ("–°—ã—Ä–Ω–∏–∫–∏","–°–∞—Ö–∞—Ä","–≥",15),
    ("–°—ã—Ä–Ω–∏–∫–∏","–°–æ–ª—å","–≥",1),
    ("–°—ã—Ä–Ω–∏–∫–∏","–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ","–º–ª",10),

    ("–ì—Ä–µ—á–∫–∞ —Å —Ç—É—à—ë–Ω–∫–æ–π","–ì—Ä–µ—á–∫–∞","–≥",80),
    ("–ì—Ä–µ—á–∫–∞ —Å —Ç—É—à—ë–Ω–∫–æ–π","–¢—É—à—ë–Ω–∫–∞ –≥–æ–≤—è–∂—å—è","–≥",120),
    ("–ì—Ä–µ—á–∫–∞ —Å —Ç—É—à—ë–Ω–∫–æ–π","–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π","–≥",20),
    ("–ì—Ä–µ—á–∫–∞ —Å —Ç—É—à—ë–Ω–∫–æ–π","–°–æ–ª—å","–≥",5),
    ("–ì—Ä–µ—á–∫–∞ —Å —Ç—É—à—ë–Ω–∫–æ–π","–°–ø–µ—Ü–∏–∏","–≥",1),

    ("–ü–∞—Å—Ç–∞ —Å —Ç–æ–º–∞—Ç–Ω—ã–º —Å–æ—É—Å–æ–º","–ü–∞—Å—Ç–∞","–≥",100),
    ("–ü–∞—Å—Ç–∞ —Å —Ç–æ–º–∞—Ç–Ω—ã–º —Å–æ—É—Å–æ–º","–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞/—Å–æ—É—Å","–≥",80),
    ("–ü–∞—Å—Ç–∞ —Å —Ç–æ–º–∞—Ç–Ω—ã–º —Å–æ—É—Å–æ–º","–ß–µ—Å–Ω–æ–∫","–≥",5),
    ("–ü–∞—Å—Ç–∞ —Å —Ç–æ–º–∞—Ç–Ω—ã–º —Å–æ—É—Å–æ–º","–û–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ","–º–ª",10),
    ("–ü–∞—Å—Ç–∞ —Å —Ç–æ–º–∞—Ç–Ω—ã–º —Å–æ—É—Å–æ–º","–°–æ–ª—å","–≥",5),

    ("–†–∏—Å —Å –æ–≤–æ—â–∞–º–∏ –∏ –∫—É—Ä–∏—Ü–µ–π","–†–∏—Å","–≥",90),
    ("–†–∏—Å —Å –æ–≤–æ—â–∞–º–∏ –∏ –∫—É—Ä–∏—Ü–µ–π","–ö—É—Ä–∏—Ü–∞ (—Ñ–∏–ª–µ)","–≥",120),
    ("–†–∏—Å —Å –æ–≤–æ—â–∞–º–∏ –∏ –∫—É—Ä–∏—Ü–µ–π","–ú–æ—Ä–∫–æ–≤—å","–≥",30),
    ("–†–∏—Å —Å –æ–≤–æ—â–∞–º–∏ –∏ –∫—É—Ä–∏—Ü–µ–π","–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π","–≥",20),
    ("–†–∏—Å —Å –æ–≤–æ—â–∞–º–∏ –∏ –∫—É—Ä–∏—Ü–µ–π","–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ","–º–ª",10),
    ("–†–∏—Å —Å –æ–≤–æ—â–∞–º–∏ –∏ –∫—É—Ä–∏—Ü–µ–π","–°–æ–ª—å","–≥",5),

    ("–ü–ª–æ–≤ –ø–æ-–ø–æ—Ö–æ–¥–Ω–æ–º—É","–†–∏—Å","–≥",100),
    ("–ü–ª–æ–≤ –ø–æ-–ø–æ—Ö–æ–¥–Ω–æ–º—É","–°–≤–∏–Ω–∏–Ω–∞/–≥–æ–≤—è–¥–∏–Ω–∞","–≥",130),
    ("–ü–ª–æ–≤ –ø–æ-–ø–æ—Ö–æ–¥–Ω–æ–º—É","–ú–æ—Ä–∫–æ–≤—å","–≥",40),
    ("–ü–ª–æ–≤ –ø–æ-–ø–æ—Ö–æ–¥–Ω–æ–º—É","–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π","–≥",25),
    ("–ü–ª–æ–≤ –ø–æ-–ø–æ—Ö–æ–¥–Ω–æ–º—É","–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ","–º–ª",12),
    ("–ü–ª–æ–≤ –ø–æ-–ø–æ—Ö–æ–¥–Ω–æ–º—É","–°–æ–ª—å","–≥",5),
    ("–ü–ª–æ–≤ –ø–æ-–ø–æ—Ö–æ–¥–Ω–æ–º—É","–ó–∏—Ä–∞/—Å–ø–µ—Ü–∏–∏","–≥",1),

    ("–®—É—Ä–ø–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è","–ì–æ–≤—è–¥–∏–Ω–∞","–≥",150),
    ("–®—É—Ä–ø–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è","–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å","–≥",150),
    ("–®—É—Ä–ø–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è","–ú–æ—Ä–∫–æ–≤—å","–≥",40),
    ("–®—É—Ä–ø–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è","–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π","–≥",25),
    ("–®—É—Ä–ø–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è","–°–æ–ª—å","–≥",6),

    ("–ë–æ—Ä—â (–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç) —Å –º—è—Å–æ–º","–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –±–æ—Ä—â–∞","–≥",40),
    ("–ë–æ—Ä—â (–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç) —Å –º—è—Å–æ–º","–ì–æ–≤—è–¥–∏–Ω–∞/—Å–≤–∏–Ω–∏–Ω–∞","–≥",120),
    ("–ë–æ—Ä—â (–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç) —Å –º—è—Å–æ–º","–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å","–≥",120),
    ("–ë–æ—Ä—â (–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç) —Å –º—è—Å–æ–º","–°–æ–ª—å","–≥",5),

    ("–û–≤–æ—â–∏ —Å —Ñ–∞—Å–æ–ª—å—é (—Ç—É—à—ë–Ω—ã–µ)","–§–∞—Å–æ–ª—å –∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–∞—è","–≥",120),
    ("–û–≤–æ—â–∏ —Å —Ñ–∞—Å–æ–ª—å—é (—Ç—É—à—ë–Ω—ã–µ)","–¢–æ–º–∞—Ç—ã —Ä–µ–∑–∞–Ω—ã–µ","–≥",120),
    ("–û–≤–æ—â–∏ —Å —Ñ–∞—Å–æ–ª—å—é (—Ç—É—à—ë–Ω—ã–µ)","–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π","–≥",20),
    ("–û–≤–æ—â–∏ —Å —Ñ–∞—Å–æ–ª—å—é (—Ç—É—à—ë–Ω—ã–µ)","–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ","–º–ª",10),
    ("–û–≤–æ—â–∏ —Å —Ñ–∞—Å–æ–ª—å—é (—Ç—É—à—ë–Ω—ã–µ)","–°–æ–ª—å","–≥",5),

    ("–ë—É—Ç–µ—Ä–±—Ä–æ–¥—ã —Å —Å—ã—Ä–æ–º –∏ –∫–æ–ª–±–∞—Å–æ–π","–•–ª–µ–±","–≥",90),
    ("–ë—É—Ç–µ—Ä–±—Ä–æ–¥—ã —Å —Å—ã—Ä–æ–º –∏ –∫–æ–ª–±–∞—Å–æ–π","–°—ã—Ä","–≥",50),
    ("–ë—É—Ç–µ—Ä–±—Ä–æ–¥—ã —Å —Å—ã—Ä–æ–º –∏ –∫–æ–ª–±–∞—Å–æ–π","–ö–æ–ª–±–∞—Å–∞","–≥",60),
    ("–ë—É—Ç–µ—Ä–±—Ä–æ–¥—ã —Å —Å—ã—Ä–æ–º –∏ –∫–æ–ª–±–∞—Å–æ–π","–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ","–≥",10),
]

–ü–†–ò–ï–ú–´_–ü–ò–©–ò = ["–ó–∞–≤—Ç—Ä–∞–∫", "–û–±–µ–¥", "–£–∂–∏–Ω"]

# ---------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ----------
@st.cache_data
def –∑–∞–≥—Ä—É–∑–∏—Ç—å_–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ_–±–ª—é–¥–∞():
    return pd.DataFrame(
        –ë–õ–Æ–î–ê_–ü–û_–£–ú–û–õ–ß–ê–ù–ò–Æ,
        columns=["–ë–ª—é–¥–æ","–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç","–ï–¥.–∏–∑–º","–ù–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞"]
    )

def excel_–ø–æ–ª–Ω—ã–π(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –ø–ª–∞–Ω_df, –±–ª—é–¥–∞_df, –∑–∞–∫—É–ø–∫–∞_df):
    """–ì–µ–Ω–µ—Ä–∏—Ç –ø–æ–ª–Ω—ã–π Excel —Å –ª–∏—Å—Ç–∞–º–∏: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è / –ü–∞—Ä–∞–º–µ—Ç—Ä—ã / –ü–ª–∞–Ω / –ë–ª—é–¥–∞ / –ó–∞–∫—É–ø–∫–∞."""
    from openpyxl import Workbook
    from openpyxl.utils import get_column_letter

    wb = Workbook()
    # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    ws = wb.active; ws.title = "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"
    —Å—Ç—Ä–æ–∫–∏ = [
        "–ú–µ–Ω—é —Å–ø–ª–∞–≤–∞: –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è",
        "1) –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –∑–∞–¥–∞–π –î–Ω–∏ –∏ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤.",
        "2) –ü–ª–∞–Ω: –≤—ã–±–µ—Ä–∏ –±–ª—é–¥–∞ –ø–æ –¥–Ω—è–º –∏ –ø—Ä–∏—ë–º–∞–º –ø–∏—â–∏.",
        "3) –ë–ª—é–¥–∞: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Ä–µ—Ü–µ–ø—Ç—ã –∏ –Ω–æ—Ä–º—ã –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞.",
        "4) –ó–∞–∫—É–ø–∫–∞: –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.",
    ]
    for i, t in enumerate(—Å—Ç—Ä–æ–∫–∏, 1):
        ws.cell(i,1,t)
    ws.column_dimensions["A"].width = 110

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
    ws_in = wb.create_sheet("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã")
    ws_in.append(["–ü–∞—Ä–∞–º–µ—Ç—Ä","–ó–Ω–∞—á–µ–Ω–∏–µ"])
    ws_in.append(["–î–Ω–∏", –ø–∞—Ä–∞–º–µ—Ç—Ä—ã["days"]])
    ws_in.append(["–£—á–∞—Å—Ç–Ω–∏–∫–∏", –ø–∞—Ä–∞–º–µ—Ç—Ä—ã["participants"]])
    ws_in.column_dimensions["A"].width = 18
    ws_in.column_dimensions["B"].width = 14

    # –ü–ª–∞–Ω
    ws_p = wb.create_sheet("–ü–ª–∞–Ω")
    –∑–∞–≥–æ–ª–æ–≤–∫–∏_–ø–ª–∞–Ω = ["–î–µ–Ω—å","–ü—Ä–∏—ë–º –ø–∏—â–∏","–ë–ª—é–¥–æ"]
    ws_p.append(–∑–∞–≥–æ–ª–æ–≤–∫–∏_–ø–ª–∞–Ω)
    for r in –ø–ª–∞–Ω_df[–∑–∞–≥–æ–ª–æ–≤–∫–∏_–ø–ª–∞–Ω].itertuples(index=False):
        ws_p.append(list(r))
    for i,w in enumerate([8,16,36],1):
        ws_p.column_dimensions[get_column_letter(i)].width = w

    # –ë–ª—é–¥–∞
    ws_d = wb.create_sheet("–ë–ª—é–¥–∞")
    –∑–∞–≥–æ–ª–æ–≤–∫–∏_–±–ª—é–¥–∞ = ["–ë–ª—é–¥–æ","–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç","–ï–¥.–∏–∑–º","–ù–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞"]
    ws_d.append(–∑–∞–≥–æ–ª–æ–≤–∫–∏_–±–ª—é–¥–∞)
    for r in –±–ª—é–¥–∞_df[–∑–∞–≥–æ–ª–æ–≤–∫–∏_–±–ª—é–¥–∞].itertuples(index=False):
        ws_d.append(list(r))
    for i,w in enumerate([28,30,10,18],1):
        ws_d.column_dimensions[get_column_letter(i)].width = w

    # –ó–∞–∫—É–ø–∫–∞
    ws_s = wb.create_sheet("–ó–∞–∫—É–ø–∫–∞")
    –∑–∞–≥–æ–ª–æ–≤–∫–∏_–∑–∞–∫—É–ø–∫–∞ = ["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç","–ï–¥.–∏–∑–º","–ò—Ç–æ–≥–æ"]
    ws_s.append(–∑–∞–≥–æ–ª–æ–≤–∫–∏_–∑–∞–∫—É–ø–∫–∞)
    for r in –∑–∞–∫—É–ø–∫–∞_df[–∑–∞–≥–æ–ª–æ–≤–∫–∏_–∑–∞–∫—É–ø–∫–∞].itertuples(index=False):
        ws_s.append(list(r))
    for i,w in enumerate([30,10,14],1):
        ws_s.column_dimensions[get_column_letter(i)].width = w

    bio = io.BytesIO()
    wb.save(bio)
    bio.seek(0)
    return bio

def pdf_–∑–∞–∫—É–ø–∫–∞(–∑–∞–∫—É–ø–∫–∞_df, font_path="DejaVuSans.ttf"):
    """PDF —Ç–æ–ª—å–∫–æ —Å —Ç–∞–±–ª–∏—Ü–µ–π –∑–∞–∫—É–ø–∫–∏ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ —á–µ—Ä–µ–∑ TTF)."""
    if not REPORTLAB_AVAILABLE:
        raise RuntimeError("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞–∫–µ—Ç reportlab. –£—Å—Ç–∞–Ω–æ–≤–∏: pip install reportlab")

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —à—Ä–∏—Ñ—Ç —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π (–µ—Å–ª–∏ —Ñ–∞–π–ª –µ—Å—Ç—å —Ä—è–¥–æ–º)
    font_name = "Cyrillic"
    if os.path.exists(font_path):
        pdfmetrics.registerFont(TTFont(font_name, font_path))
    else:
        # –ï—Å–ª–∏ TTF –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º Helvetica (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è)
        font_name = "Helvetica"

    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4)
    styles = getSampleStyleSheet()
    styles["Title"].fontName = font_name

    story = [Paragraph("–ò—Ç–æ–≥–æ–≤–∞—è –∑–∞–∫—É–ø–∫–∞ –¥–ª—è —Å–ø–ª–∞–≤–∞", styles["Title"])]

    # –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É
    –¥–∞–Ω–Ω—ã–µ = [list(–∑–∞–∫—É–ø–∫–∞_df.columns)] + –∑–∞–∫—É–ø–∫–∞_df.astype(str).values.tolist()
    table = Table(–¥–∞–Ω–Ω—ã–µ, repeatRows=1)
    table.setStyle(TableStyle([
        ('FONTNAME', (0, 0), (-1, -1), font_name),
        ('BACKGROUND', (0,0), (-1,0), colors.lightblue),
        ('TEXTCOLOR', (0,0), (-1,0), colors.black),
        ('FONTNAME', (0,0), (-1,0), font_name),
        ('FONTSIZE', (0,0), (-1,-1), 10),
        ('ALIGN',(0,0),(-1,-1),'LEFT'),
        ('BOTTOMPADDING', (0,0), (-1,0), 6),
        ('GRID', (0,0), (-1,-1), 0.5, colors.grey),
    ]))
    story.append(table)

    doc.build(story)
    buffer.seek(0)
    return buffer

# ---------- UI ----------
st.set_page_config(page_title="–ú–µ–Ω—é —Å–ø–ª–∞–≤–∞", layout="wide")
st.title("üõ∂ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–µ–Ω—é —Å–ø–ª–∞–≤–∞")

col1, col2 = st.columns(2)
with col1:
    –¥–Ω–∏ = st.number_input("–î–Ω–∏ —Å–ø–ª–∞–≤–∞", min_value=1, max_value=30, value=3, step=1)
with col2:
    —É—á–∞—Å—Ç–Ω–∏–∫–∏ = st.number_input("–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤", min_value=1, max_value=100, value=6, step=1)

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –±–ª—é–¥
if "–±–ª—é–¥–∞" not in st.session_state:
    st.session_state["–±–ª—é–¥–∞"] = –∑–∞–≥—Ä—É–∑–∏—Ç—å_–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ_–±–ª—é–¥–∞()

st.subheader("üìã –ë–ª—é–¥–∞ –∏ –Ω–æ—Ä–º—ã (–Ω–∞ 1 —á–µ–ª–æ–≤–µ–∫–∞)")
with st.expander("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤", expanded=True):
    st.session_state["–±–ª—é–¥–∞"] = st.data_editor(
        st.session_state["–±–ª—é–¥–∞"],
        num_rows="dynamic",
        use_container_width=True,
        height=420,
        key="—Ä–µ–¥–∞–∫—Ç–æ—Ä_–±–ª—é–¥",
    )
    # –ü–ª–∞–Ω –ø–æ –¥–Ω—è–º
st.subheader("üóìÔ∏è –ü–ª–∞–Ω –ø–æ –¥–Ω—è–º –∏ –ø—Ä–∏—ë–º–∞–º –ø–∏—â–∏")
–Ω–∞–∑–≤–∞–Ω–∏—è_–±–ª—é–¥ = ["‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî"] + sorted(st.session_state["–±–ª—é–¥–∞"]["–ë–ª—é–¥–æ"].dropna().unique().tolist())

–ø–ª–∞–Ω_—Å—Ç—Ä–æ–∫–∏ = []
–∫–æ–ª–æ–Ω–∫–∏ = st.columns(3)
for d in range(1, –¥–Ω–∏+1):
    with –∫–æ–ª–æ–Ω–∫–∏[(d-1) % 3]:
        st.markdown(f"–î–µ–Ω—å {d}")
        for –ø—Ä–∏—ë–º in –ü–†–ò–ï–ú–´_–ü–ò–©–ò:
            key = f"–ø–ª–∞–Ω_{d}_{–ø—Ä–∏—ë–º}"
            –≤—ã–±–æ—Ä = st.selectbox(–ø—Ä–∏—ë–º, –Ω–∞–∑–≤–∞–Ω–∏—è_–±–ª—é–¥, index=0, key=key)
            –ø–ª–∞–Ω_—Å—Ç—Ä–æ–∫–∏.append({"–î–µ–Ω—å": d, "–ü—Ä–∏—ë–º –ø–∏—â–∏": –ø—Ä–∏—ë–º, "–ë–ª—é–¥–æ": None if –≤—ã–±–æ—Ä == "‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî" else –≤—ã–±–æ—Ä})

–ø–ª–∞–Ω_df = pd.DataFrame(–ø–ª–∞–Ω_—Å—Ç—Ä–æ–∫–∏)

# –†–∞—Å—á—ë—Ç –∑–∞–∫—É–ø–∫–∏
–±–ª—é–¥–∞_df = st.session_state["–±–ª—é–¥–∞"].dropna(subset=["–ë–ª—é–¥–æ","–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç","–ï–¥.–∏–∑–º","–ù–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞"]).copy()
—Å—á—ë—Ç—á–∏–∫–∏ = –ø–ª–∞–Ω_df.dropna(subset=["–ë–ª—é–¥–æ"]).groupby("–ë–ª—é–¥–æ").size().rename("–°–∫–æ–ª—å–∫–æ —Ä–∞–∑").reset_index()
—Ä–∞—Å—á—ë—Ç = –±–ª—é–¥–∞_df.merge(—Å—á—ë—Ç—á–∏–∫–∏, on="–ë–ª—é–¥–æ", how="left").fillna({"–°–∫–æ–ª—å–∫–æ —Ä–∞–∑":0})
—Ä–∞—Å—á—ë—Ç["–ò—Ç–æ–≥–æ –ø–æ –±–ª—é–¥—É"] = —Ä–∞—Å—á—ë—Ç["–ù–æ—Ä–º–∞ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞"] * —É—á–∞—Å—Ç–Ω–∏–∫–∏ * —Ä–∞—Å—á—ë—Ç["–°–∫–æ–ª—å–∫–æ —Ä–∞–∑"]

–∑–∞–∫—É–ø–∫–∞ = (
    —Ä–∞—Å—á—ë—Ç.groupby(["–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç","–ï–¥.–∏–∑–º"], as_index=False)["–ò—Ç–æ–≥–æ –ø–æ –±–ª—é–¥—É"]
         .sum()
         .rename(columns={"–ò—Ç–æ–≥–æ –ø–æ –±–ª—é–¥—É":"–ò—Ç–æ–≥–æ"})
         .sort_values("–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç")
)

# –ò—Ç–æ–≥–æ–≤–∞—è –∑–∞–∫—É–ø–∫–∞ + –∫–Ω–æ–ø–∫–∏
st.subheader("üõí –ò—Ç–æ–≥–æ–≤–∞—è –∑–∞–∫—É–ø–∫–∞")
–∏—Ç–æ–≥ = –∑–∞–∫—É–ø–∫–∞[–∑–∞–∫—É–ø–∫–∞["–ò—Ç–æ–≥–æ"] > 0].copy()
st.dataframe(–∏—Ç–æ–≥, use_container_width=True)

# Excel (–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª —Å –ª–∏—Å—Ç–∞–º–∏)
excel_bytes = excel_–ø–æ–ª–Ω—ã–π(
    –ø–∞—Ä–∞–º–µ—Ç—Ä—ã={"days": int(–¥–Ω–∏), "participants": int(—É—á–∞—Å—Ç–Ω–∏–∫–∏)},
    –ø–ª–∞–Ω_df=–ø–ª–∞–Ω_df,
    –±–ª—é–¥–∞_df=–±–ª—é–¥–∞_df,
    –∑–∞–∫—É–ø–∫–∞_df=–∏—Ç–æ–≥
)
st.download_button(
    "üì• –°–∫–∞—á–∞—Ç—å Excel (–ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª)",
    data=excel_bytes,
    file_name="–º–µ–Ω—é_—Å–ø–ª–∞–≤–∞.xlsx",
    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
)

# PDF (—Ç–æ–ª—å–∫–æ –∑–∞–∫—É–ø–∫–∞, –±–µ–∑ –Ω—É–ª–µ–π)
try:
    pdf_bytes = pdf_–∑–∞–∫—É–ø–∫–∞(–∏—Ç–æ–≥, font_path="DejaVuSans.ttf")
    st.download_button(
        "üì• –°–∫–∞—á–∞—Ç—å PDF (—Ç–æ–ª—å–∫–æ –∑–∞–∫—É–ø–∫–∞)",
        data=pdf_bytes,
        file_name="–∑–∞–∫—É–ø–∫–∞.pdf",
        mime="application/pdf",
    )
except Exception as e:
    st.warning(f"PDF —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}\n–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞–∫–µ—Ç reportlab –∏ —Ä—è–¥–æ–º –ª–µ–∂–∏—Ç —Ñ–∞–π–ª —à—Ä–∏—Ñ—Ç–∞ DejaVuSans.ttf.")
